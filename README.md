# Cmptage

[TeraPad](http://www5f.biglobe.ne.jp/~t-susumu/library/tpad.html) などのテキストエディタで編集中の
[HSP](http://hsp.tv/)スクリプトをコンパイル・実行するためのツールです。
標準のHSPスクリプトエディタのコンパイル機能に加え、以下の機能があります。

- start.ax 作成時にファイルのサイズ表示（差分あり）
- 拡張定義によるコンパイル対象変更

このツールは橋渡し的なもので、実際のコンパイル処理は HSP に付属している hspcmp.dll が行います。
そのため HSP がインストールされていないと利用できません。

また TeraPad 以外でもコマンドラインにファイルパスを渡してツールを起動できるエディタや、
コマンドラインランチャーなどでも利用できると思います。

コンパイル済みパッケージは [releases](https://github.com/skymonsters-Ks/Cmptage/releases)
からダウンロードできます。



## 使用方法

はじめに、HSPがインストールされているフォルダに `cmptage.exe` をコピー。
（copy.hsp を HSPスクリプトエディタで開いて F5 を押すことでもコピーできます）

その後、使用するエディタの外部ツール設定で HSPフォルダの cmptage.exe を指定。
コマンドラインパラメーターの指定は以下。
```
"対象ファイルのフルパス" (オプション ...)
```
- ファイルのフルパスは指定必須、引用符 `"` で囲む（TeraPad の場合 `"%f"`）
- オプションは任意・複数可、機能が重複できないもの `/d`, `/me`, `/ma`, `/mc` は後に指定したものが優先される
- 各パラメーターは半角スペースで区切る

その他のツール設定項目は、

- 作業フォルダは指定なし
- ファイルの上書き保存をする

`cmptage_cl.exe` はコンソール版です。コンパイル結果などをウィンドウ・ダイアログを使用せず
コマンドプロンプト上でのみ動作させたい場合は cmptage.exe の代わりに利用してください。



## オプション

- **`/d`** : 実行時にデバッグウィンドウを表示します。

- **`/c`** : 実行前にコマンドライン入力ウィンドウを表示します。

  `/c="文字列"` と指定するとウィンドウを使わず文字列を送ります。コンソール版はこちらで指定してください。
  この場合、文字に `"` を使うときは ` \ ` を直前に置いてください。
  また、`%f` はカレントディレクトリ文字列、`%e` はHSPディレクトリ文字列として展開されます。
  `%%f` と `%` を続けると展開せず %f になります。

- **`/r`** : コンパイルの結果レポートを表示します。実行はされません。

- **`/i`** : UTF-8 で記述されたスクリプトをコンパイルします。

- **`/u`** : 文字列データを Shift_JIS から UTF-8 に変換してコンパイルします。

- **`/me`** : 実行ファイルを作成します。

- **`/ma`** : start.axファイルを作成します。

  ファイルのサイズと既存ファイルとのサイズの差分も表示されます。
  `/ma="ファイル名"` で作成されるaxファイル名を指定できます。パス指定可能です。

- **`/mc`** : cppファイルを作成します。

  `/mc=sjis` で Shift_JIS で作成、`/mc=utf8` で UTF-8 で作成します。
  省略すると作成時に選択します。コンソール版では省略時に Shift_JIS になります。

- **`/e`** : 後述の拡張定義を利用します。

- **`/t`** : 現在編集中の内容を hsptmp ファイルに保存してコンパイル+実行します。

  拡張定義のコンパイル対象変更と併用できません（エラーになります）。
  このパラメーターは現在 TeraPad 専用です。`/t=%w` と指定してください。
  このパラメーター使用時はファイルの上書き保存は不要です。



## 拡張定義

`/e` オプションを指定することで利用できる機能です。
スクリプトの **行頭** に特定の文字列を記述することで以下の処理をさせることができます。

- **`;$s>対象ファイル`** : コンパイルするファイルを変更します。
  `;$s>` から行末までが対象ファイル文字列として認識されます。
  `#include` 命令と併用すると便利です。絶対パス、相対パス共に有効です。
```
;$s>test.hsp
;$s>c:/hoge/test.hsp
;$s>../test.hsp
```

- **`;$c>コマンドライン文字列`** : 実行時にコマンドライン文字列を渡します。
  `;$c>` から行末までがコマンドライン文字列として認識されます。
  渡す文字列が決まっているときは `/c` オプションで毎回指定するより手間が省けます。
  `/c` オプションと同様に `%f`, `%e` の文字列が展開されます。

- **`;$a>axファイル名`** : axファイル作成時のファイル名を変更します。
  `;$a>` から行末までが対象ファイル文字列として認識されます。
  デフォルトのファイル名は `start.ax` です。
  `/ma` オプションでファイル名指定済みの場合ここでの指定が優先されます。ただしディレクトリは無視されます。

複数のファイルに同じ定義が必要な場合は `.cmpexdef` ファイルを利用すると便利です。
スクリプトと同じフォルダに拡張定義を記述した .cmpexdef ファイルを置くと、
そのフォルダにあるスクリプトは .cmpexdef の定義を用いるようになります。

拡張定義はデフォルトではファイル先頭から 512 バイトまでしか読みに行かないので初めの方に記述してください。
ただしオプションで `/e=all` と指定するとファイル全体を読みに行くようになります。
また定義が重複しているときは後に記述された定義が有効になります。
スクリプトファイルと .cmpexdef ファイルで重複しているときは前者が有効になります。

sampleフォルダのサンプルも参照してください。



## ライセンス

- [NYSL（Version 0.9982）](http://www.kmonos.net/nysl/)

