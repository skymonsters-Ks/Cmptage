# Cmptage

HSPスクリプトをコンパイル・実行するためのツールです。
HSPの標準スクリプトエディタの他、コマンドラインにファイルパスを渡してツールを起動できるエディタなどで利用できます。

このツールは橋渡し的なもので、実際のコンパイル処理はHSPに付属している`hspcmp.dll`が行います。
そのためHSPがインストールされている環境が必要です。

ツールの機能についてはオプションの項目を参照してください。

コンパイル済みパッケージは [releases](https://github.com/skymonsters-Ks/Cmptage/releases) からダウンロードできます。

ウィンドウ・ダイアログを使用する`cmptage.exe`と、コンソール上で動作する`cmptage_cl.exe`があります。



## 使用方法

はじめに、HSPがインストールされているフォルダに`cmptage.exe`をコピー。
（`copy.hsp`を HSPスクリプトエディタで開いてコンパイル+実行することでもコピーできます）

その後、使用するエディタの外部ツール設定でHSPフォルダの`cmptage.exe`を指定し下記のようにコマンドラインパラメータを設定します。

	"対象ファイルのフルパス" オプション ...

- ファイルのフルパスは指定必須、パスに半角スペースが含まれる場合はパラメータの区切りと見なされるため引用符 `"` で囲む
- オプションは任意・複数可、機能が重複できないものは後に指定したものが優先されるかエラーになる
- 各パラメーターは半角スペースで区切る

例えば [TeraPad](https://tera-net.com/library/tpad.html) で利用する場合、

	"%f" /d

と設定すると編集中のスクリプトをデバッグウィンドウ付きでコンパイル+実行します。



## オプション

- `/d` : 実行時にデバッグウィンドウを表示します。

- `/c` : 実行前にコマンドライン入力ウィンドウを表示します。

  `/c="文字列"`と指定するとウィンドウを使わず文字列を送ります。コンソール版はこちらで指定してください。
  この場合、文字に `"` を使うときは ` \ ` を直前に置いてください。
  また、`%f`はカレントディレクトリ文字列、`%e`はHSPディレクトリ文字列として展開されます。
  `%%f`とすると展開されずに %f という文字列になります。

- `/r` : コンパイルの結果レポートを表示します。実行はされません。

- `/i` : UTF-8で記述されたスクリプトをコンパイルします。`/u`オプションと併用できません。

- `/u` : 文字列データをShift_JISからUTF-8に変換してコンパイルします。`/i`オプションと併用できません。

- `/me` : 実行ファイルを作成します。

- `/ma` : start.axファイルを作成します。

  ファイルのサイズと既存ファイルとのサイズの差分も表示されます。
  `/ma="ファイル名"`で作成されるaxファイル名を指定できます。パス指定可能です。

- `/mc` : cppファイルを作成します。

  `/mc=sjis`でShift_JISで作成、`/mc=utf8`でUTF-8で作成します。
  省略すると作成時に選択します。コンソール版では省略時にShift_JISになります。

- `/e` : 後述の拡張定義を利用します。

- `/t` : 現在編集中の内容をhsptmpファイルに保存してコンパイル+実行します。

  拡張定義のコンパイル対象変更と併用できません（エラーになります）。
  このパラメーターは現在TeraPad専用です。`/t=%w`と指定してください。
  このパラメーター使用時はファイルの上書き保存は不要です。

- `/del` : 中間ファイル `obj`, `start.ax`, `packfile`, `hsptmp` を削除します。



## 拡張定義

`/e`オプションを指定することで利用できる機能です。
スクリプトの**行頭**に特定の文字列を記述することで以下の処理をさせることができます。

- `;$s>対象ファイル` : コンパイルするファイルを変更します。
  `;$s>`から行末までが対象ファイル文字列として認識されます。
  `#include`命令と併用すると便利です。絶対パス、相対パス共に有効です。

	;$s>test.hsp
	;$s>c:/hoge/test.hsp
	;$s>../test.hsp

- `;$c>コマンドライン文字列` : 実行時にコマンドライン文字列を渡します。
  `;$c>`から行末までがコマンドライン文字列として認識されます。
  渡す文字列が決まっているときは`/c`オプションで毎回指定するより手間が省けます。
  `/c`オプションと同様に`%f`,`%e`の文字列が展開されます。

- `;$a>axファイル名` : axファイル作成時のファイル名を変更します。
  `;$a>`から行末までが対象ファイル文字列として認識されます。
  デフォルトのファイル名は`start.ax`です。
  `/ma`オプションでファイル名指定済みの場合ここでの指定が優先されますがディレクトリ情報は無視されます。

複数のファイルに同じ定義が必要な場合は`.cmpexdef`ファイルを利用すると便利です。
スクリプトと同じフォルダに拡張定義を記述した`.cmpexdef`ファイルを置くと、
そのフォルダにあるスクリプトはその定義を用いるようになります。

拡張定義はデフォルトでは負荷低減のためファイル先頭から512バイトまでしか読まれないので初めの方に記述してください。
ただしオプションで `/e=all`と指定するとファイル全体が読まれるようになります。
また定義が重複しているときは後に記述された定義が優先されます。
スクリプトファイルと`.cmpexdef`ファイルで重複しているときは前者が優先されます。

sampleフォルダのサンプルも併せて参照してください。



## ライセンス

- [NYSL(Version 0.9982)](http://www.kmonos.net/nysl/)

